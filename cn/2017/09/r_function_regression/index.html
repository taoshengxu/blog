<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>R语言-线性回归-lm() - My Lives</title>
    <meta property="og:title" content="R语言-线性回归-lm() - My Lives">
    

    
      
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/blog/css/style.css" />
    <link rel="stylesheet" href="/blog/css/fonts.css" />
    <link rel="stylesheet" href="/blog/css/custom.css" />

  </head>

  
  <body class="blog">
    <header class="masthead">
      <h1><a href="/blog/">My Lives</a></h1>



      <nav class="menu">
        <input id="menu-check" type="checkbox" />
        <label id="menu-label" for="menu-check" class="unselectable">
          <span class="icon close-icon">✕</span>
          <span class="icon open-icon">☰</span>
          <span class="text">Menu</span>
        </label>
        <ul>
        
        
        <li><a href="/blog/">Home</a></li>
        
        <li><a href="/blog/en/">English</a></li>
        
        <li><a href="/blog/cn/">Chinese</a></li>
        
        <li><a href="/blog/travel/">Travel</a></li>
        
        
        </ul>
      </nav>
    </header>

    <article class="main">
      <header class="title">
      
<h1>R语言-线性回归-lm()</h1>

<h3>
  2017-09-22</h3>
<hr>


      </header>





<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<p>From <a href="http://blog.sina.com.cn/s/blog_6fbfcfb50102va2k.html">http://blog.sina.com.cn/s/blog_6fbfcfb50102va2k.html</a></p>

<h1 id="1-回归的多面性">1. 回归的多面性</h1>

<pre><code>回归类型    用途
---
简单线性    个量化的解释变量来预测一个量化的响应变量（一个因变量、一个自变量）
多项式   一个量化的解释变量预测一个量化的响应变量，模型的关系是n阶多项式（一个预测变量，但同时包含变量的幂）
多元线性    用两个或多个量化的解释变量预测一个量化的响应变量（不止一个预测变量）
多变量     用一个或多个解释变量预测多个响应变量
Logistic    用一个或多个解释变量预测一个类别型变量
泊松      用一个或多个解释变量预测一个代表频数的响应变量
Cox         用一个或多个解释变量预测一个事件（死亡、失败或旧病复发）发生的时间
时间序列  对误差项相关的时间序列数据建模
非线性   用一个或多个量化的解释变量预测一个量化的响应变量，不过模型是非线性的
非参数   用一个或多个量化的解释变量预测一个量化的响应变量，模型的形式源自数据形式，不事先设定
稳健      用一个或多个量化的解释变量预测一个量化的响应变量，能抵御强影响点的干扰
</code></pre>

<h1 id="2-用lm-拟合回归模型">2. 用lm()拟合回归模型</h1>

<p>myfit&lt;-lm(formula,data)</p>

<p>formula指要拟合的模型形式，data是一个数据框，包含了用于拟合模型的数据。</p>

<p>formula形式如下：Y~X1+X2+……+Xk （~左边为响应变量，右边为各个预测变量，预测变量之间用+符号分隔）。</p>

<p><strong>R表达式中常用的符号</strong></p>

<pre><code>符号 用途
---
~  | 分隔符号，左边为响应变量，右边为解释变量，eg：要通过x、z和w预测y，代码为y~x+z+w
+  | 分隔预测变量
： | 表示预测变量的交互项  eg：要通过x、z及x与z的交互项预测y，代码为y~x+z+x:z
*  | 表示所有可能交互项的简洁方式，代码y~x*z*w可展开为y~x+z+w+x:z+x:w+z:w+x:z:w
^  | 表示交互项达到某个次数，代码y~(x+z+w)^2可展开为y~x+z+w+x:z+x:w+z:w
.  | 表示包含除因变量外的所有变量，eg：若一个数据框包含变量x、y、z和w，代码y~.可展开为y~x+z+w
-  | 减号，表示从等式中移除某个变量，eg：y~(x+z+w)^2-x:w可展开为y~x+z+w+x:z+z:w
-1 | 删除截距项，eg：表示y~x-1拟合y在x上的回归，并强制直线通过原点
I（） | 从算术的角度来解释括号中的元素。Eg：y~x+(z+w)^2将展开为y~x+z+w+z:w。相反，代码y~x+I((z+w)^2)将展开为y~x+h，h是一个由z和w的平方和创建的新变量
function | 可以在表达式中用的数学函数，例如log(y)~x+z+w表示通过x、z和w来预测log(y)
</code></pre>

<p><strong>交互项</strong>是指你的几个变量一块生成了一个新的影响，比如不同性别的不同专业可能会对成绩有不同的影响，性别影响成绩，专业影响成绩，但是性别和专业和在一起又产生新影响。这时候就需要交互项。具体用不用看你的方程,一般不用。</p>

<p><strong>对拟合线性模型非常有用的其他函数</strong></p>

<pre><code>函数 用途
---
Summary（）展示拟合的详细结果
Coefficients（）列出拟合模型的模型参数（截距项和斜率）
confint（） 提供模型参数的置信区间（默认95%）
fitted（）列出拟合模型的预测值
residuals（）列出拟合模型的残差值
anova（）生成一个拟合模型的方差分析，或者比较两个或更多拟合模型的方差分析表
deviance() 计算残差平和和
vcov（）列出模型参数的协方差矩阵
AIC（）输出赤池信息统计量
plot（）生成评价拟合模型的诊断图
predict（）用拟合模型对新的数据集预测响应变量值
</code></pre>

<h1 id="3-r-语言示例lm">3. R 语言示例lm()</h1>

<pre><code class="language-r">fit&lt;-lm(weight~height,data=women)  
# summary(fit)
# Call:
# lm(formula = weight ~ height, data = women)
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -1.7333 -1.1333 -0.3833  0.7417  3.1167 
# Coefficients:
#              Estimate Std. Error t value Pr(&gt;|t|)    
# (Intercept) -87.51667    5.93694  -14.74 1.71e-09 ***
# height        3.45000    0.09114   37.85 1.09e-14 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Residual standard error: 1.525 on 13 degrees of freedom
# Multiple R-squared:  0.991,   Adjusted R-squared:  0.9903 
# F-statistic:  1433 on 1 and 13 DF,  p-value: 1.091e-14
coef(fit)
#(Intercept)      height 
#  -87.51667     3.45000 
fitted(fit)#拟合模型的预测值  
residuals(fit)#拟合模型的残差值 
plot(women$height,women$weight,  
     xlab=&quot;Height （in inches）&quot;,  
     ylab=&quot;Weight（in pounds）&quot;)  
abline(fit)  
</code></pre>

<p><strong>1.自变量评估</strong></p>

<p>在Pr(&gt;|t|)栏，可以看到回归系数（3.45）或者截距项显著性&lt;0.05，拒绝原假设，表明身高每增加1英寸，体重将预期地增加3.45磅.</p>

<p>*原假设H0：系数（或截距）为0。</p>

<p>*备选假设H1：系数（或截距）不为0。</p>

<p><strong>2.判定系数和F统计量</strong></p>

<p><strong>残差的标准误(Residual standard error)</strong> 1.53 lbs则可认为模型用身高预测体重的平均误差.</p>

<p><strong>判定系数R^2</strong></p>

<p>$$R^2= \frac{SSR}{SST}=\frac{\sum(\hat{Y_i}-\overline{Y})^2}{\sum(Y_i-\overline{Y})^2} $$</p>

<p><strong>R^2的取值范围为[0,1],越接近1表示回归模型对数据的解释能力越强。</strong></p>

<p><img src="https://taoshengxu.github.io/DocumentGit/img/lm_R2.jpg" alt="" /></p>

<p><strong>F统计量</strong>使用F分布检验MSR/MSE的比率，原假设：β1=0，备选假设：β1≠0. 检验简化模型\(dist=β0+\varepsilon\)与完整模型\(dist=β0+β1*x +\varepsilon\)之间的残差平方和差异的显著程度。</p>

<p><strong>3.方差分析</strong></p>

<p>线性回归中，<strong>方差分析用于评估模型或者进行模型间比较</strong>。</p>

<pre><code> m=lm(dist ~ speed, data=cars)
 summary(m)
#  Call:
# lm(formula = dist ~ speed, data = cars)
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -29.069  -9.525  -2.272   9.215  43.201 
# Coefficients:
#             Estimate Std. Error t value Pr(&gt;|t|)    
# (Intercept) -17.5791     6.7584  -2.601   0.0123 *  
# speed         3.9324     0.4155   9.464 1.49e-12 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Residual standard error: 15.38 on 48 degrees of freedom
# Multiple R-squared:  0.6511,  Adjusted R-squared:  0.6438 
# F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12

anova(m)
# Analysis of Variance Table
# Response: dist
#           Df Sum Sq Mean Sq F value   Pr(&gt;F)    
# speed      1  21186 21185.5  89.567 1.49e-12 ***
# Residuals 48  11354   236.5                     
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

reduced=lm(dist ~ 1, data=cars)  #没有自变量，仅有截距项的简化模型
anova(reduced,m)
# Analysis of Variance Table
# Model 1: dist ~ 1
# Model 2: dist ~ speed
#   Res.Df   RSS Df Sum of Sq      F   Pr(&gt;F)    
# 1     49 32539                                 
# 2     48 11354  1     21186 89.567 1.49e-12 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</code></pre>

<p>以上3组比较F统计量中p值都为1.49e-12。表面简化模型与完整模型之间存在显著差异，换言之，speed是有意义的解释变量。</p>

<p><strong>4.模型诊断图形</strong></p>

<pre><code>  plot(m,which=c(1:3,5))
</code></pre>

<p><img src="https://taoshengxu.github.io/DocumentGit/img/lm_figure.jpg" alt="" /></p>

<ul>
<li><p>第一个图为预测值Y（X轴）与残差（Y轴），在线性回归中，由于假设误差服从均值为0，方差固定的正态分布，所以认为残差分布与预测的Y值无关，残差均值必须为0。斜率为0的直线是理想情形。</p></li>

<li><p>第二个图为正态QQ图，查看标准化的残差是否服从正态分布。</p></li>

<li><p>第三个图为预测值Y（X轴）与标准化残差（Y轴），斜率为0的直线是理想情形。若在特定点观察到距离0较远的值，说明该点不能很好的拟合原始值，这些点肯能成为异常点。</p></li>

<li><p>第四个图为杠杆值（X轴）与标准化残差（Y轴）。杠杆值表示解释变量向极端的偏斜程度。</p></li>
</ul>

<p><strong>分类变量</strong></p>

<pre><code>m=lm(Sepal.Length ~ .,data=iris)
 summary(m)

# Call:
# lm(formula = Sepal.Length ~ ., data = iris)
# Residuals:
#      Min       1Q   Median       3Q      Max 
# -0.79424 -0.21874  0.00899  0.20255  0.73103 
# Coefficients:
#                   Estimate Std. Error t value Pr(&gt;|t|)    
# (Intercept)        2.17127    0.27979   7.760 1.43e-12 ***
# Sepal.Width        0.49589    0.08607   5.761 4.87e-08 ***
# Petal.Length       0.82924    0.06853  12.101  &lt; 2e-16 ***
# Petal.Width       -0.31516    0.15120  -2.084  0.03889 *  
# Speciesversicolor -0.72356    0.24017  -3.013  0.00306 ** 
# Speciesvirginica  -1.02350    0.33373  -3.067  0.00258 ** 
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Residual standard error: 0.3068 on 144 degrees of freedom
# Multiple R-squared:  0.8673,  Adjusted R-squared:  0.8627 
# F-statistic: 188.3 on 5 and 144 DF,  p-value: &lt; 2.2e-16
</code></pre>

<p>其中Species为分类变量，有三种类别：setosa,versicolor,virginica.</p>

<p><img src="https://taoshengxu.github.io/DocumentGit/img/lm_species.jpg" alt="" /></p>

<h1 id="4-多项式回归">4.多项式回归</h1>

<pre><code class="language-r">fit2&lt;-lm(weight~height+I(height^2),data=women)  
summary(fit2)
plot(women$height,women$weight,  
     xlab=&quot;Height（in inches）&quot;,  
     ylab=&quot;Weight（in lbs）&quot;)  
lines(women$height,fitted(fit2)) 

#一般来说，n次多项式生成一个n-1个弯曲的曲线
#car包中的scatterplot（）函数，可以很容易、方便地绘制二元关系图
library(car)
scatterplot(weight~height,  
            data=women,  
            spread=FALSE,  
            lty.smooth=2,  
            pch=19,  
            main=&quot;Women Age 30-39&quot;,  
            xlab=&quot;Height (inches)&quot;,  
            ylab=&quot;Weight(lbs.)&quot;) 
</code></pre>

<h1 id="6-多元线性回归">6.多元线性回归</h1>

<pre><code class="language-r">states&lt;-as.data.frame(state.x77[,c(&quot;Murder&quot;,&quot;Population&quot;,&quot;Illiteracy&quot;,&quot;Income&quot;,&quot;Frost&quot;)])
cor(states)  
scatterplotMatrix(states,spread=FALSE,lty.smooth=2,main=&quot;Scatter Plot Matrix&quot;)
#scatterplotMatrix（）函数默认在非对角线区域绘制变量间的散点图，并添加平滑（loess）和线性拟合曲线
#多元线性回归
fit&lt;-lm(Murder~Population+Illiteracy+Income+Frost,data=states)  
summary(fit)
</code></pre>

<p>对于F统计量，原假设：所有系数β全为0。</p>

<h1 id="7-有交互项的多元线性回归">7.有交互项的多元线性回归</h1>

<pre><code class="language-r">fit&lt;-lm(mpg~hp+wt+hp:wt,data=mtcars)  
summary(fit)  
# 通过effects包中的effect（）函数，可以用图形展示交互项的结果
install.packages(&quot;effects&quot;)  
library(effects)  
plot(effect(&quot;hp:wt&quot;,fit,  
            list(wt=c(2.2,3.2,4.2))),multiline=TRUE)
            
# 二次拟合诊断图
fit2&lt;-lm(weight~height+I(height^2),data=women)  
par(mfrow=c(2,2))  
plot(fit2)           
</code></pre>

<p><strong>I()</strong>防止对象解析或者转换，例如I(X^2)表示以X^2作为一个独立变量参与到回归，否者则解析为x+x+x:x交互作用。</p>

<p><img src="https://taoshengxu.github.io/DocumentGit/img/lm_interaction.jpg" alt="" /></p>

<h1 id="异常值">异常值</h1>

<p><strong>学生化残差</strong>： 残差与残差标准差的比值。</p>

<p><strong>外部学生化残差</strong>：计算第i个学生化残差时，先去掉i再计算标准差。一般用外部学生化残差评估异常点。</p>

<p>R中rstudent()计算外部学生化残差。外部学生化残差服从t分布，可以使用t-test来寻找rstudent()值过大或者过小的点。</p>

<pre><code>m=lm(circumference~ age+I(age^2),data=Orange)
rstudent(m)
car::outlierTest(m)

# No Studentized residuals with Bonferonni p &lt; 0.05
# Largest |rstudent|:
#    rstudent unadjusted p-value Bonferonni p
# 27 2.050328            0.04887           NA

</code></pre>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/cn/2017/09/step_regression/">R语言 逐步回归分析</a></span>
  <span class="nav-next"><a href="/blog/cn/2017/10/logistic/">Logistic回归</a> &rarr;</span>
</nav>





<script src="//yihui.name/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>

  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">&copy; <a href="xxxx">Who care</a> 2017 - Forever, maybe</div>
  
  </footer>
  </article>
  
  </body>
</html>


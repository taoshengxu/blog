<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>一致性指数Concordance index(CI, C-index) - My Lives</title>
    <meta property="og:title" content="一致性指数Concordance index(CI, C-index) - My Lives">
    

    
      
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/blog/css/style.css" />
    <link rel="stylesheet" href="/blog/css/fonts.css" />
    <link rel="stylesheet" href="/blog/css/custom.css" />

  </head>

  
  <body class="blog">
    <header class="masthead">
      <h1><a href="/blog/">My Lives</a></h1>



      <nav class="menu">
        <input id="menu-check" type="checkbox" />
        <label id="menu-label" for="menu-check" class="unselectable">
          <span class="icon close-icon">✕</span>
          <span class="icon open-icon">☰</span>
          <span class="text">Menu</span>
        </label>
        <ul>
        
        
        <li><a href="/blog/">Home</a></li>
        
        <li><a href="/blog/en/">English</a></li>
        
        <li><a href="/blog/cn/">Chinese</a></li>
        
        <li><a href="/blog/paper/">Paper Reading</a></li>
        
        <li><a href="/blog/travel/">Travel</a></li>
        
        
        </ul>
      </nav>
    </header>

    <article class="main">
      <header class="title">
      
<h1>一致性指数Concordance index(CI, C-index)</h1>

<h3>
  2017-10-15</h3>
<hr>


      </header>





<p><a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MDI2MQ==&amp;mid=205481962&amp;idx=1&amp;sn=f09dd122f7282be8d26b803d0039a195#rd">原文</a></p>

<p>所谓C-index，英文名全称<strong>concordance index</strong>，最早是由范德堡大学（Vanderbilt University）生物统计教教授Frank E Harrell Jr 1996年提出，主要用于计算生存分析中的COX模型预测值与真实之间的区分度（discrimination）；现阶段用的最多的是肿瘤患者预后模型的预测精度。</p>

<p>一般评价模型的好坏主要有两个方面，</p>

<ul>
<li><p>一是模型的拟合优度（Goodness of Fit),常见的评价指标主要有R方，-2logL,AIC,BIC等等；</p></li>

<li><p>另外一个是模型的预测精度，主要就是模型的真实值与预测值之间的差的大小，均方误差，相对误差等。</p></li>
</ul>

<p>从临床应用的角度来说，我们更注重后者，即统计建模主要是用于预测，而从C-index的概念大家看出它属于模型评价指标的后者，这一指标比前面提到的几个指标看起来更高大上，一般文献中用的也比较多。</p>

<p>C-index本质上是估计了预测结果与实际观察到的结果相一致的概率，即资料所有病人对子中预测结果与实际结果一致的对子所占的比例。有点类似于ROC曲线下面积。</p>

<p><font color=red><strong>C-index的计算方法是:把所研究的资料中的所有研究对象随机地两两组成对子。以生存分析为例,对于一对病人,如果生存时间较长的一位,其预测生存时间长于生存时间较短的一位,或预测的生存概率高的一位的生存时间长于生存概率低的另一位,则称之为预测结果与实际结果一致。</strong></font></p>

<p>C-index的计算步骤为:</p>

<ul>
<li><p>(1)产生所有的病例配对。若有n个观察个体,则所有的对子数应为Cn2(组合数).</p></li>

<li><p>(2)排除下面两种对子:对子中具有较小观察时间的个体没有达到观察终点及对子中两个个体都没达到观察终点。剩余的为有用对子。</p></li>

<li><p>(3)计算有用对子中,预测结果和实际相一致的对子数,即具有较坏预测结果个体的实际观察时间较短。</p></li>

<li><p>(4)计算。C= 一致对子数/有用对子数。</p></li>
</ul>

<p><strong>C-index在0.5-1之间。0.5为完全不一致,说明该模型没有预测作用,1为完全一致,说明该模型预测结果与实际完全一致。</strong></p>

<p>在实际应用中,很难找到完全一致的预测模型,既往研究认为,C-index</p>

<ul>
<li><p>在0.50-0.70为较低准确度,</p></li>

<li><p>在0.71-0.90之间为中等准确度;</p></li>

<li><p>而高于0.90则为高准确度。</p></li>
</ul>

<p>当C-index检验由同一样本建成的模型时易造成偏倚,因此再采用重抽样技术(Bootstrap)可以几乎无偏倚的检验预测模型的准确度。Bootstrap是非参数统计中一种重要的估计统计量方差进而进行区间估计的统计方法,是现代统计应用较为广泛的一种统计方法。</p>

<p>Bootstrap方法核心思想和基本步骤如下:</p>

<ul>
<li><p>(1)采用重抽样技术从原始样本中抽取一定数量的样本,此过程允许重复抽样。</p></li>

<li><p>(2)根据抽出的样本计算给定的统计量T。</p></li>

<li><p>(3)重复上述N次(一般大于1000),得到N个统计量T。</p></li>

<li><p>(4)计算上述N个统计量T的样木方差,得到统计量的方差。</p></li>
</ul>

<p>Bootstarap方法只是对单一样本且样本量较小的资料，如果数据集很大可以按照不同的比例将数据集拆分，一部分用于建模一部分用于验证。关于交叉验证（Cross-validation），由于篇幅有限，留作下次探讨。</p>

<h1 id="r软件实现">R软件实现：</h1>

<p><font color=red>Note: 在生存分析中一般直接有c-index输出，直接采用就ok.</font></p>

<p>C-index的R软件计算实现有两种实现方法，一种是用到Harrell本人的的R包Hmisc package；另一种是Le Kang, Weijie Chen 2014年12月18日发布的R compareC Package</p>

<pre><code>############################
#### Method 1.Hmisc code ###
############################
data &lt;- read.csv(&quot;survivaldta.csv&quot;)
library(Hmisc) 
library(survival) ###加载survival包，主要用于建立模型###
f &lt;- cph(Surv(time,death)~x1+x2+x3，data=survivldata) ###拟合cox模型
fp &lt;- predict(f)###模型的预测值
cindex.orig=1-rcorr.cens(fp,Surv(time,death)) [[1]]###计算出的C-index

###############################
#### Method 2.compareC code ###
###############################
data &lt;- read.csv(&quot;survivaldta.csv&quot;) 
library(compareC) 
library(survival) 
cindex &lt;- cindex(Surv(time,death) ~ x1+x2+x3,data=survivldata)###计算出的C-index

###############################
#### Bootstrap code ###
###############################
bootit=200
for(i in 1:bootit){
case=noNA[group==&quot;long&quot;,] 
control=noNA[group==&quot;&lt;24&quot;,]
bootindex.case=sample(1:nrow(case),replace=T)
boot.case.data=case[bootindex.case,]
bootindex.control=sample(1:nrow(control),replace=T)
boot.control.data=control[bootindex.control,]
boot.data=rbind(boot.case.data,boot.control.data)
dstr.boot=svydesign(id=~1, prob=~inv_weight, fpc=~ssize, data=boot.data)
boot.fit=svycoxph(Surv(survival,surv_cens) ~x1+x2+x3,data=boot.data,x=TRUE,design=dstr.boot)
cindex.train=1-rcorr.cens(lp.boot,Surv(boot.data$survival, boot.data$surv_cens))[[1]]
cindex.test=1-rcorr.cens(lp_=.test,Surv(noNA$survival,noNA$surv_cens))[[1]]
bias=rep(1,bootit)
bias[i]=abs(cindex.train-cindex.test) }
</code></pre>

<h1 id="参考文献">参考文献</h1>

<p>Harrell FE, Califf RM, Pryor DB, Lee KL, and Rosati RA. (1982) Evaluating the yield of medical tests. The Journal of the American Medical Association, 247(18), 2543–2546</p>

<p>Pencina MJ and D’Agostino RB. (2004) Overall C as a measure of discrimination in survival analysis: model specific population value and confidence interval estimation. Statistics in Medicine, 23(13), 2109–2123</p>

<p>Kang L, Chen W, Petrick NA, and Gallas BD. (2014) Comparing two correlated C indices with right-censored survival outcome: a one-shot nonparametric approach. Statistics in Medicine, 34(4), 685–703, doi: 10.1002/sim.6370</p>

<p>Hmisc Reference manual：<a href="http://cran.r-project.org/web/packages/Hmisc/Hmisc.pdf">http://cran.r-project.org/web/packages/Hmisc/Hmisc.pdf</a></p>

<p>compareC Reference manual: <a href="http://cran.r-project.org/web/packages/compareC/compareC.pdf">http://cran.r-project.org/web/packages/compareC/compareC.pdf</a></p>

<p>Frank.Harrell :<a href="http://biostat.mc.vanderbilt.edu/wiki/Main/FrankHarrell">http://biostat.mc.vanderbilt.edu/wiki/Main/FrankHarrell</a></p>

<h1 id="5-ways-to-estimate-concordance-index-for-cox-models-in-r">5 Ways to Estimate Concordance Index for Cox Models in R</h1>

<p>Why Results Aren&rsquo;t Identical?</p>

<p>Harrell&rsquo;s concordance index (c-index) can be used to evaluate the discriminatory power and the predictive accuracy of Cox models. An easy way out as a surrogate for ROC analysis.</p>

<h2 id="approach-1">Approach 1</h2>

<p>Use function &ldquo;rcorrcens&rdquo; in package &ldquo;Hmisc&rdquo;</p>

<p>Limitations:</p>

<ul>
<li><p>Can only handle un-censored data</p></li>

<li><p>Roughly handle categorical predictor with more than 2 categories</p></li>
</ul>

<pre><code>Sample code:
library(survival)
library(Hmisc)
attach(sample.data)
surv &lt;- Surv(survival, censor)
rcorrcens(surv ~ group)
</code></pre>

<h2 id="approach-2">Approach 2</h2>

<p>Direct output from coxph
Require higher version of R, say R 2.15, didn&rsquo;t test with older versions</p>

<pre><code>Sample code:
library(survival)
attach(sample.data)
surv &lt;- Surv(survival, censor)
sum.surv &lt;- summary(coxph(surv ~ group))
c_index &lt;- sum.surv$concordance
</code></pre>

<h2 id="approach-3">Approach 3</h2>

<p>Use function &ldquo;survConcordance&rdquo;
Result is the same as in Approach 2</p>

<pre><code>Sample code:
library(survival)
attach(sample.data)
surv &lt;- Surv(survival, censor)
fit &lt;- coxph( surv ~ group)
survConcordance(surv ~ predict(fit))
</code></pre>

<h2 id="approach-4">Approach 4</h2>

<p>Use package &ldquo;survcomp&rdquo; in bioconductor</p>

<p>Different result from Approach <sup>2</sup>&frasl;<sub>3</sub></p>

<p>The disparity is due to two different estimation approaches that are used to handle tied risks (i.e. cases when  two observations have the same survival with the same x). The method that approaches <sup>4</sup>&frasl;<sub>5</sub> use ignores the tied risks,  the other method (approaches <sup>2</sup>&frasl;<sub>3</sub>) takes into consideration of the tied risks. In terms of formulation/symbol (for illustration only):</p>

<p>Approaches <sup>4</sup>&frasl;<sub>5</sub> used:</p>

<p>Concordance = #all concordant pairs/#total pairs ignoring ties.</p>

<p>Approaches <sup>2</sup>&frasl;<sub>3</sub> used:</p>

<p>Concordance = (#all concordant pairs + #tied pairs/2)/(#total pairs including ties).
Those #s can be obtained in the output of Approach 3.</p>

<pre><code>Sample code:
source(&quot;http://bioconductor.org/biocLite.R&quot;)
biocLite(&quot;survcomp&quot;)
library(survcomp)
surv &lt;- Surv(survival, censor) 
fit &lt;- coxph(surv ~ group, data= sample.data)
coxPredict &lt;- predict(fit, data=sample.data, type=&quot;risk&quot;)  
concordance.index(x=coxPredict, surv.time=survival, surv.event=censor, method=&quot;noether&quot;)
</code></pre>

<h2 id="approach-5">Approach 5</h2>

<p>Use function &ldquo;cph&rdquo; in package &ldquo;rms&rdquo;
Provide both un-adjusted and bias adjusted c-index
Un-adjusted c-index is the same as the one from Approach 4</p>

<pre><code>Sample code: 
library(rms)
surv &lt;- Surv(survival, censor) 
set.seed(1)
fit.cph &lt;- cph(surv ~ group, data= sample.data, x=TRUE, y=TRUE, surv=TRUE)
  
# Get the Dxy
v &lt;- validate.cph(fit.cph, dxy=TRUE, B=1000)
Dxy = v[rownames(v)==&quot;Dxy&quot;, colnames(v)==&quot;index.corrected&quot;]
orig_Dxy = v[rownames(v)==&quot;Dxy&quot;, colnames(v)==&quot;index.orig&quot;]
# The c-statistic according to Dxy=2(c-0.5)
bias_corrected_c_index  &lt;- abs(Dxy)/2+0.5
orig_c_index &lt;- abs(Orig.Dxy)/2+0.5
</code></pre>

<h2 id="combining-approaches-2-3-4-5-and-calculate-p-value-for-testing-two-c-indices-for-both-estimation-methods">Combining Approaches <sup>2</sup>&frasl;<sub>3</sub> &amp; <sup>4</sup>&frasl;<sub>5</sub> and Calculate p-value for Testing Two C-indices for Both Estimation Methods</h2>

<p>Did not find it elsewhere online. Hope someone could find this helpful.</p>

<pre><code>Sample code:
surv &lt;- Surv(survival, censor)
c_index &lt;- function(group, ties=TRUE){
  fit &lt;- coxph(surv ~ group, data=sample.data)
  coxPredict &lt;- predict(fit, data=sample.data, type=&quot;risk&quot;)  
  
  # Approaches 4/5
  if (ties==F) {
  concordance.index(x=coxPredict, surv.time=survival, surv.event=censor, method=&quot;noether&quot;)
  }
  # Approaches 2/3
  else if (ties==T) {
  survConcordance(surv ~ coxPredict, data=sample.data)
  }
}
c_index_ties1 &lt;- c_index(group=group1, ties=TRUE)
c_index_ties2 &lt;- c_index(group=group2, ties=TRUE)

c_index_no_ties1 &lt;- c_index_ties(group=group1, ties=F)
c_index_no_ties2 &lt;- c_index_ties(group=group2, ties=F)

# p-value of testing two c-indices ignoring ties
round(cindex.comp(c_index_no_ties1, c_index_no_ties2)$p.value,3)

# Function for p-value of testing two c-indices accounting for ties
# t-test for dependent variables is used for significance 
# Input variables are objects obtained from the first function

cindex.p.ties &lt;- function(c_index_ties1, c_index_ties2, c_index_no_ties1, c_index_no_ties2) {
    eps &lt;- 1E-15
    n &lt;- c_index_no_ties1$n
    r &lt;- cor(c_index_no_ties1$data$x, c_index_no_ties2$data$x, use=&quot;complete.obs&quot;, method=&quot;spearman&quot;)
    if ((1 - abs(r)) &gt; eps) {
      t.stat &lt;- (c_index_ties1$concordance - c_index_ties2$concordance) / sqrt(c_index_ties1$std.err^2 + c_index_ties2$std.err^2 - 2 * r * c_index_ties1$std.err * c_index_ties2$std.err)
      diff.ci.p &lt;- pt(q=t.stat, df=n - 1, lower.tail=FALSE)
    } else { diff.ci.p &lt;- 1 }
    return(list(&quot;p.value&quot;=diff.ci.p))
  }
cindex.p.ties(c_index_ties1=c_index_ties1, c_index_ties2=c_index_ties2, c_index_no_ties1=c_index_no_ties1, c_index_no_ties2=c_index_no_ties2)
</code></pre>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/cn/2017/10/r_statistics/">R统计分析 </a></span>
  <span class="nav-next"><a href="/blog/cn/2017/11/1000soft/">生物信息学常见1000个软件的安装代码</a> &rarr;</span>
</nav>





<script src="//yihui.name/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>

  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">&copy; <a href="xxxx">Who care</a> 2017 - Forever, maybe</div>
  
  </footer>
  </article>
  
  </body>
</html>

